<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<html>
  <head>
    <title>Builtin rules</title>
  </head>

  <body>
    <h1>Builtin rules</h1>

    <p><i>Makepp</i> may be able to figure out how to compile and link
    your program even if you specify no rules at all (or if you don't
    even have a makefile).  After every makefile is loaded,
    <i>makepp</i> also loads a set of default rules.  (These rules are
    special in that they do not override any other rules in the
    makefile.)  The default rule database is stored in the file
    <code>makepp_builtin_rules.mk</code> in the <i>makepp</i>
    distribution or library directory, so you can always look at that to
    see exactly what the default rules are.</p>

    <p><i>Makepp</i>'s builtin rules are almost the same as the rules in
    GNU make, except that it has no rules for some of the rare languages
    that GNU make supports.  (This is deliberate; I often ran into
    trouble with GNU make on several projects that accidently reused
    some of the suffixes that GNU make assigned to those rare
    languages.)  The rules use the same variables as GNU make, with some
    possibly useful additions.  <i>Makepp</i> is smarter than GNU make
    about inferring which compiler to use, and which other objects and
    libraries to link in.</p>

    <h2>Default variable values</h2>

    <p><i>Makepp</i> supplies default values for a number of variables.
      The most important of these variables are:</p>

    <table>
      <tr>
	<td><code>CC</code></td>
	<td>The C compiler.  Makepp looks for gcc, cc, or
	  some other variants on your system and tries to pick an
	  appropriate compiler.</td>
      </tr>
      <tr>
	<td><code>CFLAGS</code></td>
	<td><code>-g</code> unless you're using the GNU compiler, in
	  which case it's <code>-g&nbsp;-Wall</code>.</td>
      </tr>
      <tr>
	<td><code>CXX</code></td>
	<td>The C++ compiler.  Makepp looks for g++, c++, cxx, or CC
	  (and a few other variants) and tries to pick an appropriate
	  value.</td>
      </tr>
      <tr>
	<td><code>CXXFLAGS</code></td>
	<td><code>-g</code> unless you're using the GNU compiler, in
	  which case it's <code>-g&nbsp;-Wall</code>.</td>
      </tr>
      <tr>
	<td><code>F77</code> or <code>FC</code></td>
	<td>The Fortran compiler.  Makepp looks for f77, g77, or
	  fort77.</td>
      </tr>
      <tr>
	<td><code>YACC</code></td>
	<td><code>yacc</code> or <code>bison&nbsp;-y</code>, depending
	  on what you have on your system.</td>
      </tr>
      <tr>
	<td><code>LEX</code></td>
	<td><code>lex</code> or <code>flex</code>, depending on what you
	  have on your system.</td>
      </tr>
    </table>

    <p><i>Makepp</i> defines a number of other variables.  These are
    mostly for compatibility with other makefiles which depend on GNU
    make's defaults; your makefile should ordinarily not depend on
    builtin variables since that is often obscure to other readers of a
    makefile.  If you have any questions about what any variable
    evaluates to, you can always put a line in your makefile like
    this:</p>
<pre>
dummy := $(print $(CC))
</pre>

    <p>which simply prints the value of the <code>$(CC)</code> variable
      when the makefile is loaded.</p>


    <h2>Compilation rules</h2>

    <p>In simplified form, here is approximately what the compilation
      rules look like.  If you change the values of any of the indicated
      variables, the compilation command is changed as expected.</p>
<pre>
#
# For C programs:
#
%.o: %.c
	$(CC) $(CFLAGS) $(CPPFLAGS) $(INCLUDES) $(TARGET_ARCH) \
	  -c $(input) -o $(output)

#
# For C++ programs:
#
%.o: %.cxx # and also %.cc, %.cpp, %.c++, and %.C
	$(CXX) $(CXXFLAGS) $(CPPFLAGS) $(INCLUDES) $(TARGET_ARCH) \
	  -c $(input) -o $(output)

#
# For fortran programs:
#
%.o: %.f
	$(FC) $(FFLAGS) $(TARGET_ARCH) -c $(input) -o $(output)

#
# Yacc and lex:
#
%.c: %.y
	$(YACC) $(YFLAGS) $(input)
	mv -f y.tab.c $(output)
%.c: %.l
	$(LEX) $(LFLAGS) -t $(input) &gt; $(output)
</pre>      

    <h2>Link rules</h2>

    <p><i>Makepp</i> also knows how to link programs, too.
    <i>Makepp</i> attempts to be more clever than the standard Unix make
    when it comes to figuring out a link command.  Suppose you are
    trying to build the target program <code>xyz</code>.  <i>Makepp</i>
    will try to build this from <code>xyz.o</code>, and (unlike the
    standard unix make) it will also attempt to infer whether any other
    objects or libraries need to be linked in.</p>

    <p>The link rule looks something like this:</p>

<pre>
xyz: $(infer_objects xyz.o, *.o)
	$(inferred linker) $(inputs) $(inferred libraries) $(LOADLIBES) $(LDLIBS) $(LIBS) -o $(output)
</pre>

    <p><code>infer_objects</code> attempts to infer what other
    <code>.o</code> files need to be linked in <a
    href="inferring.html">based on what <code>.h</code> files are
    included</a>.</p>

    <p>The "inferred linker" is a special bit of magic that
    turns into</p>
<pre>
$(CC) $(CFLAGS) $(CPPFLAGS) $(LDFLAGS) $(TARGET_ARCH)
</pre>
    <p>if the sources are all straight C code, or</p>
<pre>
$(CXX) $(CXXFLAGS) $(CPPFLAGS) $(LDFLAGS) $(TARGET_ARCH)
</pre>
    <p>if some of the sources are C++, or</p>
<pre>
$(FC) $(FFLAGS) $(LDFLAGS) $(TARGET_ARCH)
</pre>
    <p>if some of the sources are Fortran.</p>

    <p>The "inferred libraries" is another bit of magic that turns into
    a list of libraries that <i>makepp</i> thinks you probably need to
    link in based on what <code>.h</code> files were included in the
    sources.  E.g., if you include <code>jpeglib.h</code>, <i>makepp</i>
    infers <code>-ljpeg</code>; if you include <code>png.h</code>, it
    infers that you need <code>-lpng</code>.  This is currently
    experimental, and I would not be surprised if it often misses
    libraries.  You can always supply additional libraries by setting
    the values of <code>LOADLIBES</code> or <code>LDLIBS</code> or
    <code>LIBS</code>.</p>
    
    <h2>Problems with builtin rules</h2>

    <p>If you don't like the default rules, you can always turn them
      off.  This can be done by adding a line like this to your
      makefile:</p>
<pre>
makepp_no_builtin = 1
</pre>

    <p>For backward compatibility, <i>makepp</i> also turns off its
      default rules if you include this line somewhere in your makefile:</p>
<pre>
.SUFFIXES:
</pre>

    <p>If you have suggestions for better default rules or other ideas
    on how <i>makepp</i> could more intelligently infer the build rules,
    please let me know.</p>

    <hr>
    <a href="index.html">Table of contents</a>
    |
    <a href="legacy_makefiles.html">Next (legacy makefiles)</a>
    |
    <a href="extending_makepp.html">Previous (extending makepp)</a>
    <br>
<!-- Created: Tue Dec 26 18:02:11 PST 2000 -->
<!-- hhmts start -->
Last modified: Mon Jan  1 12:54:57 PST 2001
<!-- hhmts end -->
  </body>
</html>
