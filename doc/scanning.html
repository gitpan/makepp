<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<html>
  <head>
    <title>Scanning Commands and Include Files</title>
  </head>

  <body>
    <h1>Scanning Commands and Include Files</h1>

    <p><i>Makepp</i> can guess additional dependencies or targets for
    certain commands that it knows something about.  This is especially
    importat for C/C++ compilation, where it is too error-prone to list
    manually all of the include files that a given source file depends
    on.  By looking at the compilation command and the source files
    themselves, <i>makepp</i> is able to determine accurately which
    object files need to be rebuilt when some include file changes.</p>

    <p><i>Makepp</i> looks at the first word of your command line.  If
    it recognizes it, it uses the scanner corresponding to that first
    word.  Specifically, it isolates the first word and looks it up in
    its table; if nothing is found, it strips off the directory
    information and looks it up again.  (This means that you can specify
    the path to your compiler and <i>makepp</i> will still recognize
    it.)  Currently, <i>makepp</i> recognizes most C/C++ compiler names.
    It also recognizes commands invoking <code>sh</code> and
    <code>libtool</code>; for these commands, it skips to the first word
    in the command that's not an option and looks it up in the table
    again.</p>

    <p>If <i>makepp</i> thinks it's compiling a C/C++ program but can't
    find a scanner, it will give a warning message to let you know.
    This usually means that you buried your compiler command too deeply
    in the action for <i>makepp</i> to find it.  For example, I have
    seen rules like this:</p>
<pre>
%.o: %.c
	@echo Compiling $< now
	@gcc -c $< $(CFLAGS) -o $@
</pre>
    <p>The first word of the action here is <code>echo</code>, for which
    therer is no scanner, so <i>makepp</i> will not scan for include
    files in this case.</p>

    <h2>C/C++ compilation</h2>

    <p>The C/C++ scanner is activated by a command beginning with a
    compile program that <i>makepp</i> knows about.  (I've included
    every compiler I've ever heard of, but if I missed your compiler,
    you can tell <i>makepp</i> about it by adding an entry to the
    <code>%scanners</code> array.  Also send <a
    href="mailto:holt@alumni.caltech.edu">me</a> email so I can include
    it in subsequent releases.  See the section on <a
    href="#custom_scanners">custom scanners for details</a>.)</p>

    <p>It looks at the command for <code>-Idir</code> options specifying
    the include path or <code>-Ldir</code> options specifying the link
    path.  It then scans any source files for <code>#include</code>
    directives, and also looks at the command line to see if there are
    any source files or libraries mentioned which are not listed as
    dependencies.  It recognizes these by their extension.</p>

    <p>This scanner gives a warning message if files included with
    <code>#include&nbsp;"file.h"</code> are not found in the include
    path, or in the directory containing the file which is
    <code>#includ</code>ing, or in <code>/usr/include</code>.  No
    warning is given if a file included with
    <code>#include&nbsp;&lt;file.h&gt;</code> is not found.
    <i>makepp</i> assumes it is in some system include directory that
    the compiler knows about, and that files in system include
    directories won't change.</p>

    <p>In addition, files in <code>/usr/include</code>,
    <code>/usr/local/include</code>, <code>/usr/X11R6/include</code>,
    and any other directory which is not writable are not scanned to see
    what they include.  <i>Makepp</i> assumes that these files won't
    change.  (If you're running as root, the writability test is
    performed with the UID and GID of the directory you ran
    <i>makepp</i> from.  This is so compiling a program as an ordinary
    user and then doing <code>make&nbsp;install</code> as root won't
    cause extra directories to be scanned.)</p>

    <p>This is a fairly simple-minded scanner.  It will get confused if
    you do things like this:</p>
<pre>
#ifdef INCLUDE_THIS
#include "this.h"
#endif
</pre>
    <p>because it doesn't know about preprocessor conditionals.  This is
    usually harmless; it might cause additional extra files to be
    labelled as dependencies (occasionally causing unnecessary
    rebuilds), or else it might cause <i>makepp</i> to warn that the
    include file was not found.  You can either ignore the warning
    messages, or put an empty file <code>this.h</code> out there to shut
    <i>makepp</i> up.</p>

    <a name="libtool"></a>
    <h2>Libtool</h2>

    <p>Libtool is a very clever compilation system that greatly
    simplifies making shared libraries by hiding all the
    system-dependent details away in a shell script.  The only
    difficulty is that the object and library binary files are not
    actually stored in the same directory as the output file--libtool
    actuall creates a subdirectory, <code>.libs</code>, which contains
    the real files.  This is ordinarily not a problem, but <i>makepp</i>
    has to know where the real binaries are if it is to link them in
    from a repository.  Hence, a scanner has been provided for libtool
    commands which tells <i>makepp</i> where the actual files are, so
    you can use libtool without worrying about it.</p>

    <h2>Other special command words</h2>

    <p><i>Makepp</i> recognizes the following command words and skips
      over them in its search for the correct scanner:</p>
    <ul>
      <li><code>purify</code>
      <li><code>sh</code>
      <li><code>ignore_error</code>
      <li><code>noecho</code>
    </ul>

    <a name="custom_scanners"></a>

    <h2>Custom scanners</h2>

    <p>You can tell <i>makepp</i> to use a specific scanner on a
    rule-by-rule basis; see the <a
    href="syntax_makefile.html#colon_scanner"><code>:scanner</code></a>
    modifier for the rule.  If you're using an unusual compiler, or you
    want to write your own scanner for a different language, you can
    also modify <i>makepp</i>'s table of what scanners it knows about.
    The table is stored in the <code>%scanners</code> hash, which you
    can access from perl code in your makefile.</p>

    <p>For example, the outputs from a java compilation are not directly
    predictable from the command line; it depends on what nested classes
    are defined in the source file.  You could write a scanner for java
    code (contributions are welcome!) that tells <i>makepp</i> what the
    command modifies, and what the inputs to the command are, by putting
    something like this in your makefile:</p>
<pre>
<a href="syntax_makefile.html#statement_perl_begin">perl_begin</a>   # Begins a block of perl code in the makefile.

sub scanner_javac {
  my ($action, $rule) = @_;	# $action is the text of the command.
				# $rule is a reference to the Rule object
				# (see Rule.pm) which you need to add
				# dependencies and targets.
  my @cmd_words = split(' ', $action); # Get the words of the command.
  my $build_cwd = $rule-&gt;build_cwd;
#
# ... Now scan the command, pulling out the source files and figuring out
# what the targets are.
#
  ...

  foreach (@dependencies_discovered) {
    $rule-&gt;add_dependency(file_info($_, $build_cwd));
				# file_info returns makepp's handle for the
				# file.  Rule::add_dependency adds it to the
				# dependency list.
  } 

  foreach (@targets_this_command_produces) {
    $rule-&gt;add_target(file_info($_, $build_cwd))
  }
}

$scanners{"javac"} = \&amp;scanner_javac;
				# Puts the scanner in makepp's table of
				# scanners, to be activated whenever a command
				# begins with the word "javac".

end_perl			# Ends the block of perl code.
</pre>

    <p>That's pretty much all there is to it.  The name of your scanner
    function should begin with <code>scanner_</code>, because the <a
    href="syntax_makefile.html#colon_scanner"><code>:scanner</code></a>
    option adds <code>scanner_</code> to the name before looking up the
    function.</p>

    <hr>
    <a href="index.html">Table of contents</a>
    |
    <a href="inferring.html">Next (inferring objects)</a>
    |
    <a href="repositories.html">Previous (repositories)</a>
    <br>

<!-- Created: Tue Aug  8 18:36:42 PDT 2000 -->
<!-- hhmts start -->
Last modified: Sat Oct 14 22:37:27 PDT 2000
<!-- hhmts end -->
  </body>
</html>
