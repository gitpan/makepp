###	SPAR <http://www.cpan.org/scripts/>
###	52	644	1100739927	1100739925	Makeppfile
$(phony default): a b c d

export RUN := $(RUN)

MY_PATH_VAL ?= .:dir
export MY_PATH := $(MY_PATH_VAL)

B_VAL ?= b_val
export B := $(B_VAL)

perl_begin
 open(RESCAN, '>', "rescan") or die;
 close(RESCAN);

 { package CommandParser::foo;
    our @ISA = qw/CommandParser/;
    sub xparse_command {
	my $self = shift;
	open(RESCAN, '>', "rescan") or die;
	print RESCAN "yes\n";
	close(RESCAN);
	$self->add_env_dependency("FOO");
    }
 }

 sub parser_foo {
    require ActionParser::Specific;
    return new ActionParser::Specific("foo");
 }
perl_end

a:
	:env A
	echo $$A $$RUN > $@

b:
	:environment B
	echo $$B $$RUN > $@

c: : env "f in MY_PATH"
	echo $$RUN > $@

d: : scanner foo
	echo $$RUN > $@

ifdef F_IN_DIR
 dir/f:
	&touch $@
else
 f:
	&touch $@
endif
###	D	755	1100740147	1100740140	answers
###	1	644	1100655058	1100655039	answers/a-1
1
###	1	644	1100655058	1100655039	answers/a-2
2
###	1	644	1100655058	1100655039	answers/a-3
a 3
###	1	644	1100655058	1100655039	answers/b-1
b_val 1
###	1	644	1100655058	1100655039	answers/b-2
b_val 1
###	1	644	1100655058	1100655039	answers/b-3
b 3
###	1	644	1100655058	1100655039	answers/c-1
1
###	1	644	1100655058	1100655039	answers/c-2
1
###	1	644	1100655058	1100655039	answers/c-3
3
###	1	644	1100740140	1100740140	answers/d-1
1
###	1	644	1100740140	1100740140	answers/d-2
1
###	1	644	1100740140	1100740140	answers/d-3
3
###	1	644	1100740140	1100740140	answers/rescan-1
yes
###	0	644	1100740140	1100740140	answers/rescan-2
###	1	644	1100740140	1100740140	answers/rescan-3
yes
###	34	755	1100740057	1100740056	makepp_test_script
#!/bin/sh

# die immediately if any command fails
set -e

MAKEPP="${PERL-perl} ${1-makepp}"  # Grab the path to makepp.

FOO=""
export FOO
$MAKEPP RUN=1
cp a a-1
cp b b-1
cp c c-1
cp d d-1
cp rescan rescan-1

# a gets rebuilt, because $A goes from undef to ""
A=""
export A
$MAKEPP B_VAL="b_val" MY_PATH_VAL=.:nodir RUN=2
cp a a-2
cp b b-2
cp c c-2
cp d d-2
cp rescan rescan-2

A=a
unset FOO
$MAKEPP B_VAL="b" F_IN_DIR=1 RUN=3
cp a a-3
cp b b-3
cp c c-3
cp d d-3
cp rescan rescan-3
